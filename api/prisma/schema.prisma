generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model ActivityLog {
  id             Int          @id @default(autoincrement())
  organizationId Int
  entityType     String
  entityId       Int
  action         String
  metadata       String?
  performedBy    Int
  createdAt      DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User           User         @relation(fields: [performedBy], references: [id], onUpdate: NoAction)

  @@index([entityType, entityId])
  @@index([organizationId])
}

model Invite {
  id             Int          @id @default(autoincrement())
  organizationId Int
  email          String
  role           String
  token          String       @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onUpdate: NoAction)
}

model Organization {
  id                 Int                  @id @default(autoincrement())
  name               String
  slug               String               @unique
  ownerId            Int
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now())
  ActivityLog        ActivityLog[]
  Invite             Invite[]
  User               User                 @relation(fields: [ownerId], references: [id], onUpdate: NoAction)
  OrganizationMember OrganizationMember[]
  Project            Project[]
}

model OrganizationMember {
  id             Int          @id @default(autoincrement())
  userId         Int
  organizationId Int
  role           String
  isActive       Boolean      @default(true)
  joinedAt       DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User           User         @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

model Project {
  id             Int          @id @default(autoincrement())
  organizationId Int
  name           String
  description    String?
  isArchived     Boolean      @default(false)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Task           Task[]

  @@index([organizationId])
}

model Session {
  id           Int      @id @default(autoincrement())
  userId       Int
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model sysdiagrams {
  name         String @db.NVarChar(128)
  principal_id Int
  diagram_id   Int    @id(map: "PK__sysdiagr__C2B05B61F47817FD") @default(autoincrement())
  version      Int?
  definition   Bytes?

  @@unique([principal_id, name], map: "UK_principal_name")
}

model Task {
  id             Int              @id @default(autoincrement())
  projectId      Int
  title          String
  description    String?
  status         String           @default("TODO")
  priority       String           @default("MEDIUM")
  createdBy      Int
  dueDate        DateTime?
  order          Int              @default(0)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  User           User             @relation(fields: [createdBy], references: [id], onUpdate: NoAction)
  Project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  TaskAssignee   TaskAssignee[]
  TaskAttachment TaskAttachment[]
  TaskComment    TaskComment[]

  @@index([priority])
  @@index([projectId])
  @@index([projectId, order])
  @@index([status])
}

model TaskAssignee {
  id     Int  @id @default(autoincrement())
  taskId Int
  userId Int
  Task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User   User @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@unique([taskId, userId])
}

model TaskAttachment {
  id         Int      @id @default(autoincrement())
  taskId     Int
  fileName   String
  fileUrl    String
  uploadedBy Int
  createdAt  DateTime @default(now())
  Task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User       User     @relation(fields: [uploadedBy], references: [id], onUpdate: NoAction)
}

model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int
  userId    Int
  content   String
  createdAt DateTime @default(now())
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  User      User     @relation(fields: [userId], references: [id], onUpdate: NoAction)
}

model User {
  id                 Int                  @id @default(autoincrement())
  email              String               @unique
  name               String
  passwordHash       String
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @default(now())
  ActivityLog        ActivityLog[]
  Notification       Notification[]
  Organization       Organization[]
  OrganizationMember OrganizationMember[]
  Session            Session[]
  Task               Task[]
  TaskAssignee       TaskAssignee[]
  TaskAttachment     TaskAttachment[]
  TaskComment        TaskComment[]
}
